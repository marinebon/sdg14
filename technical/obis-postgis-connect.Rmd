---
title: "test-postgis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

- [marinebon/sdg14 #2: load data for infographic: NCEAS ecosystems, OBIS observations, MarineRegions EEZ, ddgrid hexagons](https://github.com/marinebon/sdg14/issues/2)

- [Loading Point Data from a CSV File in PostGIS](https://spatialdbadvisor.com/postgis_tips_tricks/118/loading-point-data-from-a-csv-file-in-postgis)

- [Chapter 4. Using PostGIS: Data Management and Queries](https://postgis.net/docs/using_postgis_dbmanagement.html#PostGIS_Geography)

- load obis csv into pg

- load eez into pg

## load obis_occ.csv into postgis db

On `ben@mbon`, connect to database docker container `postgis`:

```
sudo apt install postgresql-client-common
```

```
docker exec -it postgis bash
```

Once in `postgis` container, connect to:

```bash
psql -h localhost -U docker -p 5432 -d postgres
```

Once in `postgres=#` prompt paste sql generated by...

### generate SQL

[Loading Point Data from a CSV File in PostGIS](https://spatialdbadvisor.com/postgis_tips_tricks/118/loading-point-data-from-a-csv-file-in-postgis)


```{r create sql}
library(tidyverse)

d = read_csv('~/mbon_data_big/technical/obis/obis_occ_head10k.csv')
d = read_csv('/mbon/data_big/technical/obis/obis_occ_head10k.csv')

col_names = names(d)
col_types = sapply(names(d), function(x) class(d[[x]]))

pg_types = c('integer'='int', 'numeric'='float', 'character'='varchar')

# create table
cat(paste(c(
  'CREATE TABLE obis_occ (',
  paste(sprintf('  "%s" %s', col_names, pg_types[col_types]), collapse=',\n'),
  ');'),
  collapse='\n'))

# copy from csv
cat(paste0(c(
  "COPY obis_occ ( ",
  paste0(c(sprintf('"%s"', col_names, pg_types[col_types])), collapse=',\n    '),
  " )",
  "FROM '/mbon/data_big/technical/obis/obis_occ.csv'",
  "WITH DELIMITER AS ',' CSV HEADER NULL AS 'NA';"),
  collapse='\n'))

```

```sql
CREATE DATABASE mbon;
\connect mbon;
-- Enable PostGIS (includes raster)
CREATE EXTENSION postgis;
-- Enable Topology
CREATE EXTENSION postgis_topology;

DROP TABLE IF EXISTS obis_occ CASCADE;
CREATE TABLE obis_occ (
  "gid" SERIAL PRIMARY KEY,      -- custom
  "id" int,
  "decimalLongitude" float,
  "decimalLatitude" float,
  "institutionCode" varchar,
  "datasetName" varchar,
  "phylum" varchar,
  "class" varchar,
  "order" varchar,
  "family" varchar,
  "genus" varchar,
  "species" varchar,
  "scientificName" varchar,
  "aphiaID" int,
  "obisID" int,
  "resourceID" int,
  "year" int,
  "geog" GEOGRAPHY(POINT,4326));  -- custom

-- copy from csv
-- \copy obis_occ FROM '/mbon/data_big/technical/obis/obis_occ_head10k.csv' WITH DELIMITER ',' CSV HEADER;
-- \copy obis_occ FROM '/mbon/data_big/technical/obis/obis_occ.csv' WITH DELIMITER ',' CSV HEADER NULL AS 'NA';
COPY obis_occ ( 
    "id",
    "decimalLongitude",
    "decimalLatitude",
    "institutionCode",
    "datasetName",
    "phylum",
    "class",
    "order",
    "family",
    "genus",
    "species",
    "scientificName",
    "aphiaID",
    "obisID",
    "resourceID",
    "year") 
  FROM '/mbon/data_big/technical/obis/obis_occ.csv'
  WITH DELIMITER AS ',' CSV HEADER NULL AS 'NA';

-- Populate column with point geographies
UPDATE obis_occ AS o SET geog = ST_GeographyFromText('SRID=4326;POINT(' || "decimalLongitude" || ' ' || "decimalLatitude" || ')');

-- Create a spatial index on points
CREATE INDEX idx_obis_occ_geog ON obis_occ USING GIST(geog);

-- Create other indexes
CREATE INDEX idx_obis_occ_lon     ON obis_occ ("decimalLongitude");
CREATE INDEX idx_obis_occ_lat     ON obis_occ ("decimalLatitude");
CREATE INDEX idx_obis_occ_phylum  ON obis_occ ("phylum");
CREATE INDEX idx_obis_occ_class   ON obis_occ ("class");
CREATE INDEX idx_obis_occ_order   ON obis_occ ("order");
CREATE INDEX idx_obis_occ_family  ON obis_occ ("family");
CREATE INDEX idx_obis_occ_genus   ON obis_occ ("genus");
CREATE INDEX idx_obis_occ_species ON obis_occ ("species");
CREATE INDEX idx_obis_occ_scientificName ON obis_occ ("scientificName");
CREATE INDEX idx_obis_occ_obisID  ON obis_occ ("obisID");
CREATE INDEX idx_obis_occ_year    ON obis_occ ("year");

```

## test PG connection methods

### RPostgreSQL

```{r RPostgreSQL}
library(tidyverse)
library(RPostgreSQL)

db = list(
  host = read_delim('/etc/hosts', '\t', col_names=c('ip','host')) %>%
    separate(host, c('name','image'), extra='merge', fill='left') %>%
    filter(name=='postgis') %>%
    .$ip,
  port = 5432,
  user = 'docker',
  pass = readLines('/mbon/.pg_pass_docker'),
  name = 'mbon')
db$dsn=sprintf(
  "PG:dbname=%s host=%s port=%s user=%s password=%s", 
  db$name, db$host, db$port, db$user, db$pass)

con = dbConnect(
  dbDriver('PostgreSQL'), 
  dbname=db$name, 
  user=db$user, password=db$pass, host=db$host, port=db$port)

dbListTables(con)
dbExistsTable(con, "obis_occ")

dbGetQuery(con, 'select * from geometry_columns')
dbGetQuery(con, 'select * from geography_columns')
```



```sql
SELECT PostGIS_full_version();
```

```
POSTGIS="2.3.2 r15302" GEOS="3.4.2-CAPI-1.8.2 r3921" PROJ="Rel. 4.8.0, 6 March 
2012" GDAL="GDAL 1.10.1, released 2013/08/26" LIBXML="2.9.1" LIBJSON="0.11.99" T
OPOLOGY RASTER
```

### rgdal

```{r rgdal}
library(rgdal)

# list tables in db
ogrListLayers(db$dsn)

# fetch polygon
occ = readOGR(dsn=dsn,"obis_occ")

plot(occ)
```

### sf

```{r sf}
library(sf)

st_layers(db$dsn)
occ = st_read(db$dsn, 'obis_occ')

plot(occ['id'])


occ3 = st_read_db(con, query='SELECT * FROM obis_occ LIMIT 3')
```

## eez & obis in PG

### load eez

- [shp2pgsql: Using the ESRI Shapefile Loader | PostGIS documentation](https://postgis.net/docs/using_postgis_dbmanagement.html#shp2pgsql_usage)

```bash
# log onto mbon server
ssh ben@mbon.marine.usf.edu

# install shp2pgsql
sudo apt-get install postgis

# log into bash shell of postgis docker container 
docker exec -it postgis bash

# load eez.shp into postgis db
SHP=/mbon/data_big/technical/boundaries/eez/eez.shp
shp2pgsql -d -i -D -s 4326 -I -G $SHP eez | psql -h localhost -U docker -p 5432 -d mbon
```

on mac: `psql -h mbon.marine.usf.edu -U docker -p 5432 -d mbon`

```sql
SELECT * 
INTO obis_occ_10k
FROM obis_occ LIMIT 10000;

SELECT * 
INTO obis_occ_1k
FROM obis_occ LIMIT 1000;


SQL=/mbon/geoserver/obis_attr.sql
LOG=/mbon/geoserver/obis_attr.log
rm $LOG
echo " \
SELECT now(); \
DROP TABLE IF EXISTS obis_attr CASCADE; \
SELECT o.gid AS obis_gid, e.gid AS eez_gid \
 INTO obis_attr \
 FROM obis_occ AS o LEFT JOIN eez AS e ON ST_Intersects(o.geog, e.geog); \
 CREATE INDEX idx_obis_attr_obis ON obis_attr ("obis_gid"); \
 CREATE INDEX idx_obis_attr_eez  ON obis_attr ("eez_gid"); \
SELECT now(); \
" > $SQL
cat $SQL
psql -h localhost -U docker -p 5432 -d mbon -f $SQL -a -L $LOG &
cat $LOG
```

ps -eaf | grep psql
pid 296

```{r obis & eez}
library(sf)

st_layers(db$dsn)

# test
'

'

res = st_read_db(con, query='
  ')
st_layers(db$dsn, do_count=T)


eez2 = st_read_db(con, query='SELECT * FROM eez LIMIT 2')
occ = st_read_db(con, query='SELECT * FROM obis_occ LIMIT 10')
```

## eez simplify on pg

```{r}

res = st_read_db(con, query=
  'SELECT *, ST_SimplifyPreserveTopology(geog,0.01) AS geog INTO eez_s01 FROM eez;')
```

